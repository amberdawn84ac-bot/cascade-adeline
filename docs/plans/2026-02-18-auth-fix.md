# Auth Fix: Signup, Login, Middleware, and Onboarding

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Make signup and login work end-to-end — new users can create accounts, have a Prisma User record created, complete onboarding, and log in reliably thereafter.

**Architecture:** Supabase handles auth credentials; the app maintains its own Prisma `User` table that mirrors the Supabase `auth.users` table. On signup the client collects name+role, creates the Supabase auth account, then calls `POST /api/users` (backed by the service role key) to provision the Prisma record. The middleware is updated to use the official Supabase SSR `updateSession` pattern so cookies are refreshed correctly on every request.

**Tech Stack:** Next.js 15 App Router, Supabase SSR (`@supabase/ssr`), Prisma (custom path `src/generated/prisma`), `SUPABASE_SERVICE_ROLE_KEY` for server-side user provisioning.

---

## Root Causes (read before coding)

| # | Location | Symptom | Root Cause |
|---|---|---|---|
| 1 | `src/middleware.ts:29` | Auth gate always redirects | Checks `sb-access-token` — Supabase SSR uses `sb-[ref]-auth-token` and httpOnly cookies. Wrong name, always misses. |
| 2 | `src/components/auth/ConversationalLogin.tsx:60-73` | Signup succeeds in Supabase but app bounces back to `/login` | `handleSignUp` never creates a Prisma `User` record. `getSessionUser()` looks up Prisma, finds nothing, returns `null`. |
| 3 | Prisma `User` model | Even if we fix #2, create would fail | `name` is a required field. Signup form never asks for it. |
| 4 | No `/auth/callback` route | Email confirmation links 404 | Supabase email links redirect to `[origin]/auth/callback` which doesn't exist. |
| 5 | `ConversationalLogin.tsx:190` | Pressing Enter on password step triggers login, not signup | Form `onSubmit` = `handleLogin`; Sign Up is a secondary button — no clear mode selection. |
| 6 | Dashboard links | `/dashboard/science`, `/dashboard/math`, etc. are 404 | These room pages don't exist (only `/dashboard/arcade` does). |

---

## Task 1 — Fix Middleware (Supabase SSR Pattern)

**Files:**
- Modify: `src/middleware.ts`

**What:** Replace the broken cookie-name check with the official Supabase SSR `updateSession` approach. Also extend protection to `/dashboard` and `/chat`.

**Step 1: Replace the entire middleware with this implementation**

```typescript
// src/middleware.ts
import { NextResponse, type NextRequest } from 'next/server';
import { createServerClient } from '@supabase/ssr';

const PROTECTED_PATHS = ['/dashboard', '/chat', '/parent', '/library', '/api/clubs', '/api/transcript'];

export async function middleware(request: NextRequest) {
  let supabaseResponse = NextResponse.next({ request });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value));
          supabaseResponse = NextResponse.next({ request });
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  // IMPORTANT: Do not write logic between createServerClient and auth.getUser().
  // A simple mistake could make it very hard to debug auth issues.
  const { data: { user } } = await supabase.auth.getUser();

  // Edge timing header for observability
  supabaseResponse.headers.set('x-edge-ts', Date.now().toString());

  const { pathname } = request.nextUrl;
  const isProtected = PROTECTED_PATHS.some((p) => pathname.startsWith(p));

  if (!user && isProtected) {
    const url = request.nextUrl.clone();
    url.pathname = '/login';
    url.search = `?redirectTo=${encodeURIComponent(pathname)}`;
    return NextResponse.redirect(url);
  }

  return supabaseResponse;
}

export const config = {
  matcher: [
    // Run on all paths except static files and _next internals
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
```

**Step 2: Manual test — verify middleware runs without errors**

Start the dev server (`npm run dev`) and visit `http://localhost:3000/dashboard` in a private browser window. Expected: redirected to `/login?redirectTo=%2Fdashboard`. If you see a 500 error, check the terminal for the Supabase URL env var.

**Step 3: Commit**

```bash
git add src/middleware.ts
git commit -m "fix: replace middleware with Supabase SSR updateSession pattern, protect /dashboard and /chat"
```

---

## Task 2 — Add `/auth/callback` Route

**Files:**
- Create: `src/app/auth/callback/route.ts`

**What:** Supabase email confirmation links redirect to `[origin]/auth/callback?code=...`. This route exchanges the code for a session and redirects the user to `/onboarding` (for new users) or `/dashboard` (for returning users).

**Step 1: Create the file**

```typescript
// src/app/auth/callback/route.ts
import { NextResponse } from 'next/server';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url);
  const code = searchParams.get('code');
  const next = searchParams.get('next') ?? '/onboarding';

  if (code) {
    const cookieStore = await cookies();
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() { return cookieStore.getAll(); },
          setAll(all) { all.forEach(({ name, value, options }) => cookieStore.set(name, value, options)); },
        },
      }
    );

    const { error } = await supabase.auth.exchangeCodeForSession(code);
    if (!error) {
      return NextResponse.redirect(`${origin}${next}`);
    }
    console.error('[auth/callback] exchangeCodeForSession error:', error.message);
  }

  return NextResponse.redirect(`${origin}/login?error=auth-callback-failed`);
}
```

**Step 2: Manual test**

- In Supabase dashboard, enable "Confirm email" if not already on
- Sign up with a real email (or use Supabase inbucket for local)
- Click the confirmation link
- Expected: redirected to `/onboarding` (once that page exists) or `/dashboard`

**Step 3: Commit**

```bash
git add src/app/auth/callback/route.ts
git commit -m "feat: add Supabase auth callback route for email confirmation"
```

---

## Task 3 — Add `POST /api/users` — Prisma User Provisioning

**Files:**
- Create: `src/app/api/users/route.ts`

**What:** After Supabase creates the auth user, the client calls this endpoint to create the matching Prisma `User` record. Uses `SUPABASE_SERVICE_ROLE_KEY` to verify the Supabase user actually exists (prevents fake user creation). Is idempotent (safe to call twice).

**Step 1: Create the file**

```typescript
// src/app/api/users/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import prisma from '@/lib/db';

type CreateUserBody = {
  userId: string;
  name: string;
  role: 'student' | 'parent' | 'teacher';
};

const ROLE_MAP = {
  student: 'STUDENT',
  parent: 'PARENT',
  teacher: 'TEACHER',
} as const;

export async function POST(req: NextRequest) {
  const body = (await req.json()) as CreateUserBody;
  const { userId, name, role } = body;

  if (!userId || !name || !role || !(role in ROLE_MAP)) {
    return NextResponse.json({ error: 'Missing or invalid fields: userId, name, role required' }, { status: 400 });
  }

  // Verify the Supabase auth user actually exists using service role key
  const adminSupabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );
  const { data: authData, error: authError } = await adminSupabase.auth.admin.getUserById(userId);
  if (authError || !authData.user) {
    return NextResponse.json({ error: 'Supabase user not found' }, { status: 400 });
  }

  // Idempotent: return existing user if already provisioned
  const existing = await prisma.user.findUnique({ where: { id: userId } });
  if (existing) {
    return NextResponse.json(existing, { status: 200 });
  }

  const user = await prisma.user.create({
    data: {
      id: userId,
      email: authData.user.email!,
      name: name.trim(),
      role: ROLE_MAP[role],
    },
  });

  return NextResponse.json(user, { status: 201 });
}
```

**Step 2: Manual test with curl (replace values)**

```bash
# First get a real userId from Supabase dashboard → Auth → Users
curl -X POST http://localhost:3000/api/users \
  -H "Content-Type: application/json" \
  -d '{"userId":"paste-real-uuid","name":"Test User","role":"parent"}'
```

Expected: `{"id":"...","email":"...","name":"Test User","role":"PARENT",...}` with status 201.
Second call with same userId: status 200 (idempotent).

**Step 3: Commit**

```bash
git add src/app/api/users/route.ts
git commit -m "feat: add POST /api/users to provision Prisma User after Supabase signup"
```

---

## Task 4 — Rewrite `ConversationalLogin` — Separate Login/Signup Flows

**Files:**
- Modify: `src/components/auth/ConversationalLogin.tsx`

**What:** Separate login and signup into explicit modes. Signup flow: role → name+email → password → call Supabase signUp → call POST /api/users → redirect or show "check email". Login flow: role → email → password → signInWithPassword → redirect.

**Step 1: Replace the entire component**

```typescript
// src/components/auth/ConversationalLogin.tsx
"use client";

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { ArrowRight, GraduationCap, Users, User, Loader2, Mail } from 'lucide-react';
import { createBrowserClient } from '@supabase/ssr';
import { useRouter, useSearchParams } from 'next/navigation';

type Role = 'student' | 'parent' | 'teacher';
type Mode = 'login' | 'signup';
type LoginStep = 'role' | 'email' | 'password';
type SignupStep = 'role' | 'name-email' | 'password' | 'confirm-email';

const ROLE_LABELS: Record<Role, { title: string; subtitle: string; icon: typeof User }> = {
  student: { title: "I'm a Student", subtitle: 'Ready to learn something new', icon: User },
  parent:  { title: "I'm a Parent",  subtitle: 'Checking progress & settings', icon: Users },
  teacher: { title: "I'm a Teacher", subtitle: 'Managing curriculum', icon: GraduationCap },
};

export function ConversationalLogin() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const redirectTo = searchParams.get('redirectTo') || '/dashboard';

  const [mode, setMode] = useState<Mode>('login');
  const [loginStep, setLoginStep] = useState<LoginStep>('role');
  const [signupStep, setSignupStep] = useState<SignupStep>('role');

  const [role, setRole] = useState<Role | null>(null);
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

  function switchMode(newMode: Mode) {
    setMode(newMode);
    setError(null);
    setLoginStep('role');
    setSignupStep('role');
    setRole(null);
    setName('');
    setEmail('');
    setPassword('');
  }

  // ── LOGIN FLOW ──────────────────────────────────────────────
  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      router.refresh();
      router.push(redirectTo);
    } catch (err: unknown) {
      setError(err instanceof Error ? err.message : 'Failed to sign in');
      setLoading(false);
    }
  };

  const handleForgotPassword = async () => {
    if (!email) { setError('Enter your email first, then click Forgot Password.'); return; }
    setLoading(true);
    setError(null);
    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/auth/callback?next=/reset-password`,
      });
      if (error) throw error;
      setError('Password reset email sent! Check your inbox.');
    } catch (err: unknown) {
      setError(err instanceof Error ? err.message : 'Failed to send reset email');
    } finally {
      setLoading(false);
    }
  };

  // ── SIGNUP FLOW ──────────────────────────────────────────────
  const handleSignup = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      const { data, error: signUpError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: `${window.location.origin}/auth/callback?next=/onboarding`,
        },
      });

      if (signUpError) throw signUpError;
      if (!data.user) throw new Error('Signup returned no user');

      // Provision Prisma User record
      const res = await fetch('/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: data.user.id, name: name.trim(), role }),
      });
      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        throw new Error(body.error || 'Failed to create user profile');
      }

      if (data.session) {
        // Auto-confirm enabled (local dev) — go straight to onboarding
        router.refresh();
        router.push('/onboarding');
      } else {
        // Email confirmation required
        setSignupStep('confirm-email');
      }
    } catch (err: unknown) {
      setError(err instanceof Error ? err.message : 'Failed to sign up');
      setLoading(false);
    }
  };

  // ── RENDER HELPERS ──────────────────────────────────────────
  const RoleButtons = ({ onSelect }: { onSelect: (r: Role) => void }) => (
    <div className="space-y-3">
      {(Object.entries(ROLE_LABELS) as [Role, typeof ROLE_LABELS[Role]][]).map(([key, { title, subtitle, icon: Icon }]) => (
        <button
          key={key}
          onClick={() => onSelect(key)}
          className="w-full p-4 rounded-xl border-2 border-[#E7DAC3] hover:border-[#BD6809] hover:bg-[#FFF3E7] transition-all flex items-center gap-4 group text-left"
        >
          <div className="p-3 bg-[#E7DAC3]/30 rounded-full text-[#BD6809] group-hover:bg-[#BD6809] group-hover:text-white transition-colors">
            <Icon size={24} />
          </div>
          <div>
            <div className="font-bold text-[#2F4731]">{title}</div>
            <div className="text-sm text-[#2F4731]/60">{subtitle}</div>
          </div>
        </button>
      ))}
    </div>
  );

  const inputClass = "w-full p-4 rounded-xl border-2 border-[#E7DAC3] focus:border-[#BD6809] outline-none bg-[#FFFDF5] text-lg";
  const backBtn = (onClick: () => void) => (
    <button type="button" onClick={onClick} className="text-[#2F4731]/60 hover:text-[#2F4731] text-sm font-bold">
      Back
    </button>
  );
  const nextBtn = (label = 'Next') => (
    <button type="submit" className="bg-[#BD6809] text-white px-8 py-3 rounded-xl font-bold hover:bg-[#A05808] transition-colors flex items-center gap-2">
      {label} <ArrowRight size={20} />
    </button>
  );
  const submitBtn = (label: string) => (
    <button type="submit" disabled={loading} className="flex-1 bg-[#2F4731] text-white px-6 py-3 rounded-xl font-bold hover:bg-[#1E2E20] transition-colors disabled:opacity-50">
      {loading ? <Loader2 className="animate-spin mx-auto" size={20} /> : label}
    </button>
  );

  return (
    <div className="w-full max-w-md mx-auto p-6">
      <div className="mb-8 text-center">
        <h1 className="text-3xl font-bold text-[#2F4731] mb-2" style={{ fontFamily: 'var(--font-emilys-candy), cursive' }}>
          Welcome to Adeline
        </h1>
        <p className="text-[#BD6809] font-medium">Your personalized learning companion</p>
      </div>

      {/* Mode toggle */}
      <div className="flex mb-6 bg-[#F5EFE0] rounded-2xl p-1">
        {(['login', 'signup'] as Mode[]).map((m) => (
          <button
            key={m}
            onClick={() => switchMode(m)}
            className={`flex-1 py-2 rounded-xl font-bold text-sm transition-all ${mode === m ? 'bg-white text-[#2F4731] shadow-sm' : 'text-[#2F4731]/50'}`}
          >
            {m === 'login' ? 'Sign In' : 'Create Account'}
          </button>
        ))}
      </div>

      <div className="bg-white rounded-[2rem] p-8 shadow-xl border border-[#E7DAC3] relative overflow-hidden min-h-[380px] flex flex-col justify-center">
        <AnimatePresence mode="wait">

          {/* ── LOGIN STEPS ── */}
          {mode === 'login' && loginStep === 'role' && (
            <motion.div key="login-role" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }} className="space-y-6">
              <h2 className="text-2xl font-bold text-[#2F4731] text-center mb-6" style={{ fontFamily: 'var(--font-emilys-candy), cursive' }}>Who is visiting today?</h2>
              <RoleButtons onSelect={(r) => { setRole(r); setLoginStep('email'); }} />
            </motion.div>
          )}

          {mode === 'login' && loginStep === 'email' && (
            <motion.div key="login-email" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }}>
              <h2 className="text-2xl font-bold text-[#2F4731] text-center mb-6" style={{ fontFamily: 'var(--font-emilys-candy), cursive' }}>What's your email?</h2>
              <form onSubmit={(e) => { e.preventDefault(); if (email.trim()) setLoginStep('password'); }} className="space-y-6">
                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="name@example.com" className={`${inputClass} text-center`} autoFocus required />
                <div className="flex justify-between items-center">{backBtn(() => setLoginStep('role'))}{nextBtn()}</div>
              </form>
            </motion.div>
          )}

          {mode === 'login' && loginStep === 'password' && (
            <motion.div key="login-password" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }}>
              <h2 className="text-2xl font-bold text-[#2F4731] text-center mb-6" style={{ fontFamily: 'var(--font-emilys-candy), cursive' }}>Your secret key?</h2>
              <form onSubmit={handleLogin} className="space-y-4">
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="••••••••" className={`${inputClass} text-center`} autoFocus required />
                {error && <p className="text-red-500 text-sm text-center font-bold bg-red-50 p-2 rounded-lg">{error}</p>}
                <div className="flex justify-between items-center">
                  {backBtn(() => setLoginStep('email'))}
                  {submitBtn('Sign In')}
                </div>
                <div className="text-center">
                  <button type="button" onClick={handleForgotPassword} disabled={loading} className="text-[#BD6809] text-sm hover:underline disabled:opacity-50">
                    Forgot password?
                  </button>
                </div>
              </form>
            </motion.div>
          )}

          {/* ── SIGNUP STEPS ── */}
          {mode === 'signup' && signupStep === 'role' && (
            <motion.div key="signup-role" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }} className="space-y-6">
              <h2 className="text-2xl font-bold text-[#2F4731] text-center mb-6" style={{ fontFamily: 'var(--font-emilys-candy), cursive' }}>I am a...</h2>
              <RoleButtons onSelect={(r) => { setRole(r); setSignupStep('name-email'); }} />
            </motion.div>
          )}

          {mode === 'signup' && signupStep === 'name-email' && (
            <motion.div key="signup-name-email" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }}>
              <h2 className="text-2xl font-bold text-[#2F4731] text-center mb-6" style={{ fontFamily: 'var(--font-emilys-candy), cursive' }}>Tell me about you</h2>
              <form onSubmit={(e) => { e.preventDefault(); if (name.trim() && email.trim()) setSignupStep('password'); }} className="space-y-4">
                <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="Your first name" className={inputClass} autoFocus required />
                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="name@example.com" className={inputClass} required />
                <div className="flex justify-between items-center">{backBtn(() => setSignupStep('role'))}{nextBtn()}</div>
              </form>
            </motion.div>
          )}

          {mode === 'signup' && signupStep === 'password' && (
            <motion.div key="signup-password" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }}>
              <h2 className="text-2xl font-bold text-[#2F4731] text-center mb-6" style={{ fontFamily: 'var(--font-emilys-candy), cursive' }}>Choose a secret key</h2>
              <form onSubmit={handleSignup} className="space-y-4">
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="At least 8 characters" className={`${inputClass} text-center`} autoFocus required minLength={8} />
                {error && <p className="text-red-500 text-sm text-center font-bold bg-red-50 p-2 rounded-lg">{error}</p>}
                <div className="flex justify-between items-center">
                  {backBtn(() => setSignupStep('name-email'))}
                  {submitBtn('Create Account')}
                </div>
              </form>
            </motion.div>
          )}

          {mode === 'signup' && signupStep === 'confirm-email' && (
            <motion.div key="signup-confirm" initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="text-center space-y-6 py-4">
              <div className="mx-auto w-16 h-16 bg-[#FFF3E7] rounded-full flex items-center justify-center">
                <Mail size={32} className="text-[#BD6809]" />
              </div>
              <h2 className="text-2xl font-bold text-[#2F4731]" style={{ fontFamily: 'var(--font-emilys-candy), cursive' }}>Check your email!</h2>
              <p className="text-[#2F4731]/70 leading-relaxed">
                We sent a confirmation link to <span className="font-bold text-[#BD6809]">{email}</span>. Click it to activate your account, then come back here to sign in.
              </p>
              <button onClick={() => switchMode('login')} className="text-[#BD6809] font-bold hover:underline text-sm">
                Back to Sign In
              </button>
            </motion.div>
          )}

        </AnimatePresence>
      </div>
    </div>
  );
}
```

**Step 2: Manual test — Login flow**

1. Go to `http://localhost:3000/login`
2. Click "Sign In" tab (should be default)
3. Select a role → enter email → enter wrong password → expected: "Invalid login credentials" error
4. Enter correct password → expected: redirect to `/dashboard`

**Step 3: Manual test — Signup flow**

1. Click "Create Account" tab
2. Select "Student" → enter a name and email → choose password (8+ chars)
3. If email confirmation ON: expected "Check your email" step
4. If auto-confirm: expected redirect to `/onboarding` (page stub is Task 5)

**Step 4: Commit**

```bash
git add src/components/auth/ConversationalLogin.tsx
git commit -m "feat: rewrite ConversationalLogin with separate login/signup flows, collect name+role on signup, add forgot password"
```

---

## Task 5 — Create `/onboarding` Page

**Files:**
- Create: `src/app/onboarding/page.tsx`

**What:** New users land here after signup. Collects grade level and interests. Updates the Prisma `User` record. Then redirects to `/dashboard`. Requires a logged-in session.

**Step 1: Create the page**

```typescript
// src/app/onboarding/page.tsx
import { getSessionUser } from '@/lib/auth';
import { redirect } from 'next/navigation';
import { OnboardingForm } from '@/components/auth/OnboardingForm';

export default async function OnboardingPage() {
  const user = await getSessionUser();
  if (!user) redirect('/login');
  return <OnboardingForm userId={user.userId} userName={user.email?.split('@')[0] || 'Friend'} />;
}
```

**Step 2: Create the onboarding form component**

```typescript
// src/components/auth/OnboardingForm.tsx
"use client";

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Loader2, ArrowRight } from 'lucide-react';

const GRADE_OPTIONS = [
  { value: 'K-2', label: 'Kindergarten – 2nd Grade' },
  { value: '3-5', label: '3rd – 5th Grade' },
  { value: '6-8', label: '6th – 8th Grade' },
  { value: '9-12', label: '9th – 12th Grade' },
];

const INTEREST_OPTIONS = [
  'Science', 'Math', 'History', 'Writing', 'Coding', 'Art',
  'Music', 'Gardening', 'Business', 'Animals', 'Building',
];

type Props = { userId: string; userName: string };

export function OnboardingForm({ userName }: Props) {
  const router = useRouter();
  const [gradeLevel, setGradeLevel] = useState('');
  const [interests, setInterests] = useState<string[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const toggleInterest = (interest: string) => {
    setInterests((prev) =>
      prev.includes(interest) ? prev.filter((i) => i !== interest) : [...prev, interest]
    );
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!gradeLevel) { setError('Please select a grade level.'); return; }
    setLoading(true);
    setError(null);
    try {
      const res = await fetch('/api/users/onboarding', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ gradeLevel, interests }),
      });
      if (!res.ok) throw new Error('Failed to save profile');
      router.push('/dashboard');
    } catch (err: unknown) {
      setError(err instanceof Error ? err.message : 'Something went wrong');
      setLoading(false);
    }
  };

  return (
    <div style={{ minHeight: '100vh', background: '#FFFEF7', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem' }}>
      <div className="w-full max-w-lg">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-[#2F4731] mb-2" style={{ fontFamily: 'var(--font-emilys-candy), cursive' }}>
            Welcome, {userName}!
          </h1>
          <p className="text-[#BD6809] font-medium">Let's personalize your learning journey.</p>
        </div>
        <div className="bg-white rounded-[2rem] p-8 shadow-xl border border-[#E7DAC3]">
          <form onSubmit={handleSubmit} className="space-y-8">
            {/* Grade Level */}
            <div>
              <label className="block text-[#2F4731] font-bold mb-3">What grade level?</label>
              <div className="grid grid-cols-2 gap-3">
                {GRADE_OPTIONS.map(({ value, label }) => (
                  <button
                    key={value}
                    type="button"
                    onClick={() => setGradeLevel(value)}
                    className={`p-3 rounded-xl border-2 text-sm font-bold transition-all ${
                      gradeLevel === value
                        ? 'border-[#BD6809] bg-[#FFF3E7] text-[#BD6809]'
                        : 'border-[#E7DAC3] text-[#2F4731]/70 hover:border-[#BD6809]'
                    }`}
                  >
                    {label}
                  </button>
                ))}
              </div>
            </div>

            {/* Interests */}
            <div>
              <label className="block text-[#2F4731] font-bold mb-3">What do you love? (pick any)</label>
              <div className="flex flex-wrap gap-2">
                {INTEREST_OPTIONS.map((interest) => (
                  <button
                    key={interest}
                    type="button"
                    onClick={() => toggleInterest(interest)}
                    className={`px-4 py-2 rounded-full border-2 text-sm font-bold transition-all ${
                      interests.includes(interest)
                        ? 'border-[#2F4731] bg-[#2F4731] text-white'
                        : 'border-[#E7DAC3] text-[#2F4731]/70 hover:border-[#2F4731]'
                    }`}
                  >
                    {interest}
                  </button>
                ))}
              </div>
            </div>

            {error && <p className="text-red-500 text-sm font-bold bg-red-50 p-3 rounded-xl">{error}</p>}

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-[#2F4731] text-white py-4 rounded-xl font-bold text-lg hover:bg-[#1E2E20] transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
            >
              {loading ? <Loader2 className="animate-spin" size={20} /> : <><span>Start Learning</span><ArrowRight size={20} /></>}
            </button>
          </form>
        </div>
      </div>
    </div>
  );
}
```

**Step 3: Create the `PATCH /api/users/onboarding` endpoint**

```typescript
// src/app/api/users/onboarding/route.ts
import { NextRequest, NextResponse } from 'next/server';
import prisma from '@/lib/db';
import { getSessionUser } from '@/lib/auth';

export async function PATCH(req: NextRequest) {
  const user = await getSessionUser();
  if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });

  const { gradeLevel, interests } = await req.json();

  await prisma.user.update({
    where: { id: user.userId },
    data: {
      gradeLevel: gradeLevel || null,
      interests: Array.isArray(interests) ? interests : [],
    },
  });

  return NextResponse.json({ ok: true });
}
```

**Step 4: Manual test**

1. Complete the signup flow → land on `/onboarding`
2. Select a grade level and interests → click "Start Learning"
3. Expected: redirect to `/dashboard`
4. In Supabase dashboard or via Prisma Studio, verify the user record has gradeLevel and interests set

**Step 5: Commit**

```bash
git add src/app/onboarding/page.tsx src/components/auth/OnboardingForm.tsx src/app/api/users/onboarding/route.ts
git commit -m "feat: add onboarding page to collect grade level and interests after signup"
```

---

## Task 6 — Add Missing Dashboard Room Pages

**Files:**
- Create: `src/app/(routes)/dashboard/science/page.tsx`
- Create: `src/app/(routes)/dashboard/math/page.tsx`
- Create: `src/app/(routes)/dashboard/ela/page.tsx`
- Create: `src/app/(routes)/dashboard/history/page.tsx`

The dashboard links to these routes (`/dashboard/science`, `/dashboard/math`, `/dashboard/ela`, `/dashboard/history`) but they 404. Arcade already exists. Add stubs that render a "Coming Soon" state in the Adeline aesthetic.

**Step 1: Create a shared room stub component**

```typescript
// src/components/dashboard/RoomStub.tsx
import { type LucideIcon } from 'lucide-react';
import Link from 'next/link';
import { ArrowLeft } from 'lucide-react';

type Props = {
  title: string;
  subtitle: string;
  description: string;
  icon: LucideIcon;
  color: string;
};

export function RoomStub({ title, subtitle, description, icon: Icon, color }: Props) {
  return (
    <div className="space-y-8">
      <Link href="/dashboard" className="inline-flex items-center gap-2 text-[#2F4731]/60 hover:text-[#2F4731] font-bold text-sm transition-colors">
        <ArrowLeft size={16} /> Back to Rooms
      </Link>
      <div className={`rounded-[2rem] p-12 text-center space-y-6 border-2 ${color}`}>
        <div className="mx-auto w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-md">
          <Icon size={40} className="text-[#BD6809]" />
        </div>
        <h1 className="text-4xl font-bold text-[#2F4731]" style={{ fontFamily: 'var(--font-emilys-candy), cursive' }}>
          {title}
        </h1>
        <p className="text-[#2F4731]/60 font-bold uppercase tracking-widest text-sm">{subtitle}</p>
        <p className="text-[#2F4731]/80 max-w-md mx-auto leading-relaxed">{description}</p>
        <div className="inline-block px-6 py-3 bg-[#BD6809]/10 border-2 border-[#BD6809]/30 rounded-2xl text-[#BD6809] font-bold text-sm">
          This room is being furnished — check back soon!
        </div>
      </div>
    </div>
  );
}
```

**Step 2: Create each room page**

```typescript
// src/app/(routes)/dashboard/science/page.tsx
import { FlaskConical } from 'lucide-react';
import { RoomStub } from '@/components/dashboard/RoomStub';
export default function SciencePage() {
  return <RoomStub title="The Laboratory" subtitle="Life Sciences & Chemistry" description="Track experiments, nature journals, and scientific method mastery." icon={FlaskConical} color="border-emerald-500/20 bg-emerald-500/5" />;
}

// src/app/(routes)/dashboard/math/page.tsx
import { Calculator } from 'lucide-react';
import { RoomStub } from '@/components/dashboard/RoomStub';
export default function MathPage() {
  return <RoomStub title="The Counting House" subtitle="Applied Math & Business" description="Manage your business, calculate profits, and master algebra." icon={Calculator} color="border-amber-500/20 bg-amber-500/5" />;
}

// src/app/(routes)/dashboard/ela/page.tsx
import { Feather } from 'lucide-react';
import { RoomStub } from '@/components/dashboard/RoomStub';
export default function ElaPage() {
  return <RoomStub title="The Scriptorium" subtitle="Rhetoric & Communication" description="Write stories, analyze texts, and build your portfolio." icon={Feather} color="border-rose-500/20 bg-rose-500/5" />;
}

// src/app/(routes)/dashboard/history/page.tsx
import { ScrollText } from 'lucide-react';
import { RoomStub } from '@/components/dashboard/RoomStub';
export default function HistoryPage() {
  return <RoomStub title="The Great Archive" subtitle="History & Discernment" description="Explore primary sources and uncover the truth of the past." icon={ScrollText} color="border-indigo-500/20 bg-indigo-500/5" />;
}
```

**Step 3: Manual test**

Visit each room from the dashboard grid. Expected: each room renders the "Coming Soon" stub with a Back link.

**Step 4: Commit**

```bash
git add src/components/dashboard/RoomStub.tsx \
  src/app/\(routes\)/dashboard/science/page.tsx \
  src/app/\(routes\)/dashboard/math/page.tsx \
  src/app/\(routes\)/dashboard/ela/page.tsx \
  src/app/\(routes\)/dashboard/history/page.tsx
git commit -m "feat: add stub room pages for science, math, ela, history dashboards"
```

---

## Task 7 — Commit Outstanding CRLF Changes

**Files with uncommitted CRLF normalization:**
- `adeline.config.toml`
- `src/lib/config.ts`
- `src/lib/db.ts`
- `src/lib/redis.ts`

**Step 1: Stage and commit**

```bash
git add adeline.config.toml src/lib/config.ts src/lib/db.ts src/lib/redis.ts
git commit -m "chore: normalize line endings (CRLF → LF)"
```

---

## Task 8 — End-to-End Verification

**Manual test checklist:**

```
[ ] Unauthenticated user visits /dashboard → redirected to /login
[ ] Unauthenticated user visits /chat → redirected to /login
[ ] Unauthenticated user visits /parent → redirected to /login
[ ] Login page loads — both "Sign In" and "Create Account" tabs visible
[ ] Sign Up flow: role → name+email → password → (confirm email step OR onboarding)
[ ] New user Prisma record visible in DB with correct name, role, gradeLevel
[ ] Onboarding page: select grade + interests → redirects to /dashboard
[ ] Login flow: role → email → wrong password → error shown
[ ] Login flow: correct credentials → redirects to /dashboard
[ ] Forgot password: enter email on password step → success message
[ ] Dashboard rooms: click Science/Math/ELA/History → stub page, not 404
[ ] Dashboard Arcade → existing page loads
[ ] Authenticated user can log out and lose access to protected routes
```

---

## Summary of Files Created/Modified

| File | Action |
|---|---|
| `src/middleware.ts` | Modified — Supabase SSR pattern, extended route protection |
| `src/app/auth/callback/route.ts` | Created — email confirmation handler |
| `src/app/api/users/route.ts` | Created — Prisma User provisioning |
| `src/app/api/users/onboarding/route.ts` | Created — PATCH gradeLevel + interests |
| `src/app/onboarding/page.tsx` | Created — post-signup onboarding page |
| `src/components/auth/OnboardingForm.tsx` | Created — onboarding form component |
| `src/components/auth/ConversationalLogin.tsx` | Modified — separate login/signup, name field, forgot password |
| `src/components/dashboard/RoomStub.tsx` | Created — shared stub component |
| `src/app/(routes)/dashboard/science/page.tsx` | Created — stub |
| `src/app/(routes)/dashboard/math/page.tsx` | Created — stub |
| `src/app/(routes)/dashboard/ela/page.tsx` | Created — stub |
| `src/app/(routes)/dashboard/history/page.tsx` | Created — stub |
| `adeline.config.toml` + 3 lib files | Committed CRLF changes |
